#!/bin/bash -e
# Thanks ChatGPT

GITHUB_USERNAME="$1"

if [ -z "$GITHUB_USERNAME" ]; then
  read -p "Enter Github username: " GITHUB_USERNAME
fi

if [ -z "$GITHUB_TOKEN" ]; then
  read -sp "Enter Github access token: " GITHUB_TOKEN
fi

# Set up variables for pagination
PAGE=1
PER_PAGE=100
HAS_NEXT_PAGE=true

# Loop through pages of repositories
while [ "${HAS_NEXT_PAGE}" == true ]
do
  # Construct API endpoint URL with pagination parameters
  API_URL="https://api.github.com/users/${GITHUB_USERNAME}/repos?page=${PAGE}&per_page=${PER_PAGE}"

  # Get repositories for the current page using the Github API
  REPOS=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" ${API_URL})

  # If the API response has an empty array of repositories, we've reached the end of the list
  if [ "$REPOS" == "[]" ]; then
    HAS_NEXT_PAGE=false
  else
    # Loop through each repository and clone it
    for repo in $(echo "$REPOS" | jq -r '.[].clone_url')
    do
      # Thanks Copilot
      if [ -d "$repo" ]; then
        echo "Skipping $repo because it already exists."
        continue
      fi

      git clone "$repo"
    done

    # Move on to the next page of repositories
    PAGE=$((PAGE+1))
  fi
done

# Done!
echo "All repositories have been cloned."
